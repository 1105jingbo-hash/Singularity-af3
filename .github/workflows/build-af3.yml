name: Build and Release AF3 Singularity Image

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Maximize Build Space
        run: |
          # 极致清理，腾出 30GB+ 空间
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc "/usr/local/share/boost" /usr/lib/jvm
          sudo docker image prune -a -f
          sudo apt-get clean
          df -h

      - name: Install Apptainer
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libseccomp-dev pkg-config squashfs-tools cryptsetup
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.0/apptainer_1.3.0_amd64.deb
          sudo apt-get install -y ./apptainer_1.3.0_amd64.deb

      - name: Build SIF Image
        run: |
          # 确保在 /mnt (66GB 剩余) 运行
          sudo mkdir -p /mnt/tmp
          sudo chmod 777 /mnt/tmp
          export APPTAINER_TMPDIR=/mnt/tmp
          export APPTAINER_CACHEDIR=/mnt/tmp
          # 显式指定输出到 /mnt/alphafold3.sif
          sudo -E apptainer build --disable-cache --force /mnt/alphafold3.sif alphafold3.def

      - name: Split and Prepare Release
        run: |
          # 1. 验证文件物理存在
          if [ ! -f /mnt/alphafold3.sif ]; then echo "错误: 镜像文件未找到!"; exit 1; fi
          ls -lh /mnt/alphafold3.sif
          
          # 2. 压缩并分卷 (每个包 1.8GB，不超过 GitHub 2GB 限制)
          # 使用 sudo 确保读取权限，-C 确保相对路径压缩
          sudo tar -cvz -C /mnt alphafold3.sif | split -b 1800M - alphafold3.sif.tar.gz.
          
          # 3. 检查生成结果 (如果看到文件大小只有几十字节，说明失败)
          ls -lh alphafold3.sif.tar.gz.*

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: v1.1.${{ github.run_number }}
          name: AlphaFold3 SIF Release v1.1.${{ github.run_number }}
          files: alphafold3.sif.tar.gz.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
