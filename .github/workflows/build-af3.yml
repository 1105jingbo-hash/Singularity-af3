name: Build and Release AF3 Singularity Image

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 极其彻底的磁盘清理，预计可腾出 30GB+ 空间
      - name: Maximize Build Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf /usr/lib/jvm
          sudo rm -rf /var/lib/apt/lists/*
          sudo docker image prune -a -f
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: Install Apptainer
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libseccomp-dev pkg-config squashfs-tools cryptsetup
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.0/apptainer_1.3.0_amd64.deb
          sudo apt-get install -y ./apptainer_1.3.0_amd64.deb

      - name: Build SIF Image
        run: |
          # 1. 在空间巨大的 /mnt 分区创建工作目录
          sudo mkdir -p /mnt/tmp
          sudo chmod 777 /mnt/tmp
          
          # 2. 强制指定所有 Apptainer 路径到 /mnt
          export APPTAINER_TMPDIR=/mnt/tmp
          export APPTAINER_CACHEDIR=/mnt/tmp
          
          # 3. 运行构建
          # 注意：我们将输出路径也指向 /mnt 以确保写入空间
          sudo -E apptainer build --disable-cache --force /mnt/alphafold3.sif alphafold3.def
          
          # 4. 构建完成后，将成品移回当前目录以便上传 Release
          sudo mv /mnt/alphafold3.sif .
          sudo rm -rf /mnt/tmp/*

      - name: Split and Prepare Release
        run: |
          # 1. 明确检查镜像是否存在
          ls -lh /mnt/alphafold3.sif
          
          # 2. 直接使用绝对路径进行压缩和分卷
          # -C /mnt 告诉 tar 切换到该目录执行，这样就不会有路径警告
          # sudo 确保可以读取 root 拥有的 sif 文件
          sudo tar -cvz -C /mnt alphafold3.sif | split -b 1500M - alphafold3.sif.tar.gz.
          
          # 3. 确认生成的文件（正常情况下应该有多个几百MB或1.5GB的文件）
          ls -lh alphafold3.sif.tar.gz.*

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: AlphaFold3 SIF (Split) v1.0.${{ github.run_number }}
          files: alphafold3.sif.tar.gz.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
