name: Build and Release AF3 Singularity Image

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 极其彻底的磁盘清理，预计可腾出 30GB+ 空间
      - name: Maximize Build Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf /usr/lib/jvm
          sudo rm -rf /var/lib/apt/lists/*
          sudo docker image prune -a -f
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: Install Apptainer
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libseccomp-dev pkg-config squashfs-tools cryptsetup
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.0/apptainer_1.3.0_amd64.deb
          sudo apt-get install -y ./apptainer_1.3.0_amd64.deb

      - name: Build SIF Image
        run: |
          # 创建临时目录
          mkdir -p $GITHUB_WORKSPACE/tmp
          export APPTAINER_TMPDIR=$GITHUB_WORKSPACE/tmp
          export APPTAINER_CACHEDIR=$GITHUB_WORKSPACE/tmp
          
          # 使用 --disable-cache 并在构建前再次确认空间
          df -h
          sudo -E apptainer build --disable-cache --force alphafold3.sif alphafold3.def
          
          # 构建完成后清理临时目录，确保有空间进行最后的 SIF 压缩转换
          rm -rf $GITHUB_WORKSPACE/tmp/*

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: AlphaFold3 SIF Release v1.0.${{ github.run_number }}
          files: alphafold3.sif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
